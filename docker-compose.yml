services:
  customer-db:
    image: postgres:16
    container_name: customer-db
    environment:
      POSTGRES_DB: customer_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5433:5432"
    volumes:
      - customer_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  payment-db:
    image: postgres:16
    container_name: payment-db
    environment:
      POSTGRES_DB: payment_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5434:5432"
    volumes:
      - payment_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  parking-db:
    image: postgres:16
    container_name: parking-db
    environment:
      POSTGRES_DB: parking_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5435:5432"
    volumes:
      - parking_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  admin-db:
    image: postgres:16
    container_name: admin-db
    environment:
      POSTGRES_DB: admin_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5436:5432"
    volumes:
      - admin_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  worker-db:
    image: postgres:16
    container_name: worker-db
    environment:
      POSTGRES_DB: worker_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5437:5432"
    volumes:
      - worker_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  account-db:
    image: postgres:16
    container_name: account-db
    environment:
      POSTGRES_DB: account_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5438:5432"
    volumes:
      - account_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  company-db:
    image: postgres:16
    container_name: company-db
    environment:
      POSTGRES_DB: company_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5439:5432"
    volumes:
      - company_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  ocr-db:
    image: postgres:16
    container_name: ocr-db
    environment:
      POSTGRES_DB: ocr_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - "5440:5432"
    volumes:
      - ocr_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - smartparking-network

  customer-service:
    build:
      context: .
      dockerfile: Dockerfile.customer-service
    container_name: customer-service
    depends_on:
      customer-db:
        condition: service_healthy
      customer-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://customer-db:5432/customer_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN:-}
      PARKING_SERVICE_URL: http://parking-service:8083
      PAYMENT_SERVICE_URL: http://payment-service:8082
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    networks:
      - smartparking-network

  payment-service:
    build:
      context: .
      dockerfile: Dockerfile.payment-service
    container_name: payment-service
    depends_on:
      payment-db:
        condition: service_healthy
      payment-db-init:
        condition: service_completed_successfully
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://payment-db:5432/payment_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      CUSTOMER_SERVICE_URL: http://customer-service:8081
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN:-}
    networks:
      - smartparking-network

  parking-service:
    build:
      context: .
      dockerfile: Dockerfile.parking-service
    container_name: parking-service
    depends_on:
      parking-db:
        condition: service_healthy
      parking-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    ports:
      - "8083:8083"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://parking-db:5432/parking_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN:-}
      CUSTOMER_SERVICE_URL: http://customer-service:8081
      PAYMENT_SERVICE_URL: http://payment-service:8082
      ACCOUNTS_SERVICE_URL: http://accounts-service:8087
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    networks:
      - smartparking-network

  admin-service:
    build:
      context: .
      dockerfile: Dockerfile.admin-service
    container_name: admin-service
    depends_on:
      admin-db:
        condition: service_healthy
      admin-db-init:
        condition: service_completed_successfully
    ports:
      - "8084:8084"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://admin-db:5432/admin_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      PARKING_SERVICE_URL: http://parking-service:8083
    networks:
      - smartparking-network

  worker-service:
    build:
      context: .
      dockerfile: Dockerfile.worker-service
    container_name: worker-service
    depends_on:
      worker-db:
        condition: service_healthy
      worker-db-init:
        condition: service_completed_successfully
    ports:
      - "8085:8085"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://worker-db:5432/worker_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      PARKING_SERVICE_URL: http://parking-service:8083
    networks:
      - smartparking-network

  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.api-gateway
    container_name: api-gateway
    ports:
      - "8090:8090"
    environment:
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      ROUTES_CUSTOMER_SERVICE: http://customer-service:8081
      ROUTES_PAYMENT_SERVICE: http://payment-service:8082
      ROUTES_PARKING_SERVICE: http://parking-service:8083
      ROUTES_ADMIN_SERVICE: http://admin-service:8084
      ROUTES_WORKER_SERVICE: http://worker-service:8085
      ROUTES_ACCOUNTS_SERVICE: http://accounts-service:8087
      ROUTES_COMPANY_SERVICE: http://company-service:8091
      ROUTES_OCR_SERVICE: http://ocr-service:8086
    networks:
      - smartparking-network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: smartparking-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_ERLANG_COOKIE: SWQOKODSQALRPCLNMEQG
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - smartparking-network

  accounts-service:
    build:
      context: .
      dockerfile: Dockerfile.accounts-service
    container_name: accounts-service
    depends_on:
      account-db:
        condition: service_healthy
      account-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_started
    ports:
      - "8087:8087"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://account-db:5432/account_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      VERIFICATION_BASE_URL: ${VERIFICATION_BASE_URL:-http://localhost:3000}
    networks:
      - smartparking-network

  company-service:
    build:
      context: .
      dockerfile: Dockerfile.company-service
    container_name: company-service
    depends_on:
      company-db:
        condition: service_healthy
      company-db-init:
        condition: service_completed_successfully
    ports:
      - "8091:8091"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://company-db:5432/company_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
    networks:
      - smartparking-network

  ocr-service:
    build:
      context: .
      dockerfile: Dockerfile.ocr-service
    container_name: ocr-service
    depends_on:
      ocr-db:
        condition: service_healthy
      ocr-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_started
    ports:
      - "8086:8086"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://ocr-db:5432/ocr_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS:-postgres}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      JWT_SECRET: ${JWT_SECRET:-superSecretKeyChangeMeTo32CharsMin_123456}
    networks:
      - smartparking-network

  email-service:
    build:
      context: .
      dockerfile: Dockerfile.email-service
    container_name: email-service
    depends_on:
      rabbitmq:
        condition: service_started
    ports:
      - "8088:8088"
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      GMAIL_USERNAME: ${GMAIL_USERNAME:-}
      GMAIL_APP_PASSWORD: ${GMAIL_APP_PASSWORD:-}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - smartparking-network

  customer-db-init:
    image: postgres:16
    container_name: customer-db-init
    depends_on:
      customer-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for customer-db...'
        until pg_isready -h customer-db -U postgres; do sleep 1; done
        echo 'Customer-db is ready'
        echo 'Importing customer_db.sql...'
        psql -h customer-db -U postgres -d customer_db -f /sql/customer_db.sql 2>&1 || echo "Error importing customer_db.sql"
        echo 'Customer database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  payment-db-init:
    image: postgres:16
    container_name: payment-db-init
    depends_on:
      payment-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for payment-db...'
        until pg_isready -h payment-db -U postgres; do sleep 1; done
        echo 'Payment-db is ready'
        echo 'Importing payment_db.sql...'
        psql -h payment-db -U postgres -d payment_db -f /sql/payment_db.sql 2>&1 || echo "Error importing payment_db.sql"
        echo 'Payment database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  parking-db-init:
    image: postgres:16
    container_name: parking-db-init
    depends_on:
      parking-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for parking-db...'
        until pg_isready -h parking-db -U postgres; do sleep 1; done
        echo 'Parking-db is ready'
        echo 'Importing parking_db.sql...'
        psql -h parking-db -U postgres -d parking_db -f /sql/parking_db.sql 2>&1 || echo "Error importing parking_db.sql"
        echo 'Parking database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  admin-db-init:
    image: postgres:16
    container_name: admin-db-init
    depends_on:
      admin-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for admin-db...'
        until pg_isready -h admin-db -U postgres; do sleep 1; done
        echo 'Admin-db is ready'
        echo 'Importing admin_db.sql...'
        psql -h admin-db -U postgres -d admin_db -f /sql/admin_db.sql 2>&1 || echo "Error importing admin_db.sql"
        echo 'Admin database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  worker-db-init:
    image: postgres:16
    container_name: worker-db-init
    depends_on:
      worker-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for worker-db...'
        until pg_isready -h worker-db -U postgres; do sleep 1; done
        echo 'Worker-db is ready'
        echo 'Importing worker_db.sql...'
        psql -h worker-db -U postgres -d worker_db -f /sql/worker_db.sql 2>&1 || echo "Error importing worker_db.sql"
        echo 'Worker database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  account-db-init:
    image: postgres:16
    container_name: account-db-init
    depends_on:
      account-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for account-db...'
        until pg_isready -h account-db -U postgres; do sleep 1; done
        echo 'Account-db is ready'
        echo 'Importing account_db.sql...'
        psql -h account-db -U postgres -d account_db -f /sql/account_db.sql 2>&1 || echo "Error importing account_db.sql"
        echo 'Account database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  company-db-init:
    image: postgres:16
    container_name: company-db-init
    depends_on:
      company-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for company-db...'
        until pg_isready -h company-db -U postgres; do sleep 1; done
        echo 'Company-db is ready'
        echo 'Importing company_db.sql...'
        psql -h company-db -U postgres -d company_db -f /sql/company_db.sql 2>&1 || echo "Error importing company_db.sql"
        echo 'Company database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

  ocr-db-init:
    image: postgres:16
    container_name: ocr-db-init
    depends_on:
      ocr-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASS:-postgres}
    volumes:
      - ./database-test:/sql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo 'Waiting for ocr-db...'
        until pg_isready -h ocr-db -U postgres; do sleep 1; done
        echo 'OCR-db is ready'
        echo 'Importing ocr_db.sql...'
        psql -h ocr-db -U postgres -d ocr_db -f /sql/ocr_db.sql 2>&1 || echo "Error importing ocr_db.sql"
        echo 'OCR database initialization completed'
    networks:
      - smartparking-network
    restart: "no"

volumes:
  customer_db_data:
  payment_db_data:
  parking_db_data:
  admin_db_data:
  worker_db_data:
  account_db_data:
  company_db_data:
  ocr_db_data:
  rabbitmq_data:

networks:
  smartparking-network:
    driver: bridge
